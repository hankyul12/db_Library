<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script>

	function loan() {
		// 상품 ID와 사용자 ID를 가져옵니다.
		var temp = location.href.split("?");
		var data = temp[1].split(",");
		var bookid = data[0]; // 상품 ID
		var myid = localStorage.getItem('id'); // 사용자 ID (localStorage에서 가져오기)

		if (!myid) {
			alert("로그인된 사용자가 없습니다. 로그인후 대출해주세요!");
			return;
		}

		// XMLHttpRequest 객체를 생성합니다.
		var request = new XMLHttpRequest();

		// 대출 요청을 보낼 URL (bookid와 myid를 파라미터로 추가)
		var url = "loan.jsp?id=" + bookid + "&memberId=" + myid;

		// GET 방식으로 요청을 보냅니다.
		request.open("GET", url, true);

		// 요청 상태 변화에 따라 처리
		request.onreadystatechange = function() {
			if (request.readyState == 4) { // 요청 완료
				if (request.status == 200) { // 응답 성공
					var response = request.responseText;
					alert(response);
					if (response.trim() === "true") {
						alert("대출이 완료되었습니다.");
					} else {
						alert("대출 실패. 다시 시도해주세요.");
					}
				} else {
					alert("서버와의 통신에 실패했습니다. 다시 시도해주세요.");
				}
			}
		};

		// 요청 전송
		request.send(null);
	}
	
	function reservation(){
		var temp = location.href.split("?");
		var data = temp[1].split(",");
		var bookid = data[0]; // 상품 ID
		var myid = localStorage.getItem('id'); // 사용자 ID (localStorage에서 가져오기)

		if (!myid) {
			alert("로그인된 사용자가 없습니다. 로그인후 대출해주세요!");
			return;
		}

		// XMLHttpRequest 객체를 생성합니다.
		var request = new XMLHttpRequest();

		// 대출 요청을 보낼 URL (bookid와 myid를 파라미터로 추가)
		var url = "reservation.jsp?id=" + bookid + "&memberId=" + myid;
		alert(url);
		// GET 방식으로 요청을 보냅니다.
		request.open("GET", url, true);

		// 요청 상태 변화에 따라 처리
		request.onreadystatechange = function() {
			if (request.readyState == 4) { // 요청 완료
				if (request.status == 200) { // 응답 성공
					var response = request.responseText;
					alert(response);
					if (response.trim() === "true") {
						alert("예약이 완료되었습니다.");
					} else {
						alert("예약 실패. 다시 시도해주세요.");
					}
				} else {
					alert("서버와의 통신에 실패했습니다. 다시 시도해주세요.");
				}
			}
		};

		// 요청 전송
		request.send(null);
	}
</script>
</head>

<body>
<table id="detail">
    	<tr>
        	<td rowspan="5" id="itemImg">
            	<img id="img1" src="" alt="상품 이미지" height="480" width="300">
        	</td>
        	<td>
            	<h2 id='title'>게시글 제목</h2>
        	</td>
    	</tr>
    	<tr>
        	<td>
            	<h3 id ="author" class="text"> 작가 : <span id='authorSpan'></span></h3>
        	</td>
    	</tr>
    	<tr>
        	<td>
            	<p id='genre' class="text">장르 : <span id='genreSpan'></span></p>
        	</td>
    	</tr>
    	<tr>
        	<td>
            	<h2 id='quantity' class="text">보유 개수 :</h2>
        	</td>
    	</tr>
    	<tr>
        	<td>
            	<button id="loan" onclick="loan()" class="text">대출하기</button>
            	<button id="reservation" onclick="reservation()" class="text" >예약하기</button>
        	</td>
    	</tr>
	</table>
</body>
<script>
	window.onload = function() {
		var temp = location.href.split("?");
		var data = temp[1].split(",");
		var value1 = data[0];
	
		var aimg = document.getElementById("img1");
		aimg.src= "img/"+value1+'.png';
	
	
		myid = value1;
		createRequest();
		var url = "itemDetail.jsp?id="+myid;
		request.open("GET", url, true);
		request.onreadystatechange = updatePage;
		request.send(null);
	};


	function createRequest(){
	 try{
	    request = new XMLHttpRequest();
	 }catch(failed){
	    request = null;
	 }
	 if(request == null){
	    alert("Error creating request object!");
	 }
	
	}


	function updatePage(){      
 	 if(request.readyState == 4){
		 var title = document.getElementById('title');
		 var genre = document.getElementById('genreSpan');
		 var author = document.getElementById('authorSpan');
		 var loan_button= document.getElementById("loan");
		 var reservation_button = document.getElementById("reservation");
		 
 	    var rows = request.responseText;
 	    var rowData = rows.split("&"); // 각 열의 데이터를 분리합니다.
 	    title.innerText=rowData[1];
 	   	genre.innerText = rowData[2];
 	    author.innerText += rowData[7];
 	    quantity.innerText += rowData[3];

		if(rowData[3] > 0){
			quantity.innerText += "권 / 대출 가능";
			reservation_button.disabled = true;
		}
		else{
			quantity.innerText += "권 / 예약 가능";
			loan_button.disabled = true;
		}
	  }
	}
	

</script>
</html>